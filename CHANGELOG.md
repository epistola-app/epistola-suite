# Epistola Suite Changelog

## [Unreleased]

### Changed
- Separated frontend (pnpm) and backend (Gradle) build steps for simpler configuration
  - Frontend: `pnpm install && pnpm build` builds all modules in `modules/`
  - Backend: `./gradlew build` compiles, tests, and packages (requires frontend built first)
  - Gradle verifies frontend is built before packaging, failing with helpful error if not
  - Removed node-gradle plugin dependency for cleaner Gradle configuration
  - CI workflow updated to run pnpm build before Gradle with proper caching

### Added
- pnpm workspaces for frontend module management
  - Root `pnpm-workspace.yaml` orchestrates all modules in `modules/`
  - Unified dependency management and build commands from repo root
  - `pnpm build` builds all modules, `pnpm --filter @epistola/<module> build` for specific modules
- Import maps for shared JavaScript dependencies to avoid duplicate bundling
  - `modules/vendor` package uses Rollup to bundle React, ReactDOM, Zustand, and Immer as proper ESM with named exports
  - Custom entry wrappers ensure CJS packages export named bindings (not just default)
  - Editor module excludes shared dependencies via Vite externals (~750KB vs ~1.1MB bundle)
  - Thymeleaf import map fragment (`fragments/importmap.html`) for browser-native dependency resolution
  - Shared dependencies loaded once and cached, reducing page load time for multiple interactive components

### Changed
- Simplified template editor data passing by using Thymeleaf's native JavaScript serialization
  - Removed unnecessary JSON stringify/parse roundtrip in template handler
  - `templateModel` is now passed directly to the view and serialized by Thymeleaf

### Added
- Docker image build configuration with JVM and native options
  - JVM image (default): `./gradlew bootBuildImage`
  - Native image (disabled): `./gradlew bootBuildImage -PnativeImage=true` - broken due to JDBI/Kotlin reflection ([jdbi#2475](https://github.com/jdbi/jdbi/issues/2475))
  - Images signed with Cosign and SBOM attested
- CloudNativePG (CNPG) support in Helm chart for PostgreSQL database management
  - Three database modes: `cnpg` (create cluster), `cnpgExisting` (use existing), `external` (manual config)
  - New `database.type` configuration with discriminator pattern
  - Automatic CNPG Cluster resource creation when `database.type: cnpg`
  - Support for consuming existing CNPG cluster credentials
  - Backward compatibility with deprecated `postgresql.*` configuration
  - Post-install notes with cluster status and connection commands
- Extended document templates with data model and examples support
  - Renamed `content` column to `templateModel` (visual layout definition)
  - Added `dataModel` column for JSON Schema definitions
  - Added `dataExamples` column for named JSON examples that validate against the schema
  - JSON Schema validation using networknt/json-schema-validator 3.0.0 (Jackson 3 compatible)
  - `PATCH /tenants/{tenantId}/templates/{id}` endpoint for partial updates
  - Strict validation: examples must conform to schema, schema changes validate existing examples
- Form validation for tenant and template creation
  - Validation in command constructors using `require()` for fail-fast behavior
  - Name is required (non-blank) and max 255 characters
  - Inline error display below form fields using HTMX retarget/reswap
  - CSS styles for error states (red border, error message styling)
  - Form value preservation on validation error
- Testing documentation (`docs/testing.md`) covering test infrastructure, patterns, and best practices
  - Test framework overview (JUnit 5, Testcontainers, Spring Boot Test, AssertJ, Kover)
  - Guide to BaseIntegrationTest and TestFixture DSL usage
  - HTTP/route testing patterns including HTMX header handling
  - Testcontainers configuration and troubleshooting tips
- Command/Query Bus (Mediator pattern) for centralized message dispatching
  - `Command<R>` and `Query<R>` marker interfaces for type-safe message passing
  - `CommandHandler` and `QueryHandler` interfaces for handler implementations
  - `Mediator` interface with `send()` for commands and `query()` for queries
  - `SpringMediator` auto-discovers handlers via Spring's `ApplicationContext`
  - Decouples consumers from handlers enabling future cross-cutting concerns
- TestFixture Kotlin DSL for given-when-then style integration tests
  - Type-safe DSL with `@DslMarker` annotation to prevent scope leakage
  - `GivenContext` for test data setup with automatic cleanup
  - `WhenContext` for executing actions under test
  - `ThenContext` with `result<T>()` helper for type-safe result access
  - Automatic tenant cleanup after each test to ensure isolation
- Tenant management UI on homepage
  - Homepage (`/`) displays list of tenants with name and creation date
  - Form to create new tenants directly on the page
  - Search functionality to filter tenants by name
  - Each tenant links to their templates at `/tenants/{id}/templates`
  - Templates list shows breadcrumb navigation back to tenants
  - All template URLs are now tenant-scoped: `/tenants/{tenantId}/templates`
  - API endpoints are tenant-scoped: `/api/tenants/{tenantId}/templates/{id}`
- Multi-tenancy support for tenant isolation
  - New `Tenant` entity with `id`, `name`, and `createdAt` fields
  - `CreateTenant` and `DeleteTenant` commands for tenant management (internal use)
  - All `DocumentTemplate` records now belong to a tenant (required foreign key)
  - Tenant-scoped queries and commands prevent cross-tenant data access
  - Database migrations create `tenants` table and add `tenant_id` to `document_templates`
  - Default tenant (id=1) created for existing data during migration
  - Cascade delete: removing a tenant deletes all its templates
- Editor development modes for live reload
  - **Standalone mode** (`npm run dev`): Full Vite HMR for developing the editor in isolation
  - **Integrated mode** (`npm run watch`): Continuous builds for embedding in Thymeleaf pages
  - Editor module includes Kotlin/Spring auto-configuration
  - Vite watch auto-starts when `epistola.editor.dev-server.auto-start=true`
  - Spring Boot serves editor files from filesystem in `local` profile for fast iteration
  - Development workflow: run Spring Boot with `local` profile, editor rebuilds on file changes
- Editor component integration with Thymeleaf templates
    - Library build mode for the React editor (`mountEditor()` API)
    - Editor can be embedded in Thymeleaf pages while sharing the app layout
    - New `/templates/{id}/editor` route to open the visual template editor
    - REST API endpoints for saving template content (`PUT /api/templates/{id}`)
    - CSS isolation to prevent style conflicts between editor and parent page
    - Edit links added to the templates list page
- HTMX utilities for WebMvc.fn functional endpoints
  - `ServerRequest.isHtmx` extension property for detecting HTMX requests
  - `ServerRequest.render()` helper for HTMX-aware template rendering
  - `ServerRequest.htmx { }` Kotlin DSL for advanced responses:
    - Multiple fragments with Out-of-Band (OOB) swaps
    - Conditional rendering logic
    - Response headers: `trigger()`, `pushUrl()`, `reswap()`, `retarget()`
    - Non-HTMX fallback with `onNonHtmx { }`
  - `HxSwap` enum for all HTMX swap modes
  - Additional extensions: `htmxTrigger`, `htmxTarget`, `htmxBoosted`, etc.
- Automatic PR labeling based on changed files
  - Labels PRs with `backend`, `frontend`, `infrastructure`, or `documentation` based on file paths
  - Uses `actions/labeler@v5` with sync-labels to keep labels up-to-date
- Command-based architecture with JDBI for database access
  - Vertical slices: organize by feature (commands/, queries/) not by layer
  - JDBI 3.49.0 with Kotlin and Postgres plugins
  - Query handlers pattern for read operations
  - CreateDocumentTemplate command with handler for write operations
- Document Templates page with Thymeleaf rendering
  - New `/templates` endpoint displaying a table of document templates
  - Form to create new templates directly on the page (POST /templates)
  - Uses Spring WebMvc.fn functional endpoints (RouterFunction + Handler pattern)
  - Basic security configuration permitting public access to templates page
  - CSS styling for table and form components
  - Flyway migration for document_templates table

### Changed
- Migrated version management from asdf to mise for faster tool installation

- Updated documentation to reflect server-side rendering architecture (Thymeleaf + HTMX) instead of implying a Vite/TypeScript SPA frontend
  - CLAUDE.md: Added Frontend Architecture section, clarified project overview and structure
  - README.md: Added Architecture section, updated project description and modules
  - CONTRIBUTING.md: Added Thymeleaf + HTMX code style section, updated frontend label description
  - .github/labels.yml: Updated frontend label description

### Fixed
- Docker image now uses JDK 25 to match the build environment, fixing Kotlin reflection errors at runtime
- Labels sync workflow now works with private repositories by adding `contents: read` permission
- Docker image build in CI now explicitly sets image name to `epistola-suite` via `--imageName` flag to ensure consistent naming across build and push steps
- Helm chart security scan failures (AVD-KSV-0014, AVD-KSV-0118): added proper pod and container security contexts with `readOnlyRootFilesystem`, `seccompProfile`, `allowPrivilegeEscalation: false`, and capability drops

### Added
- Test coverage reporting using Kover with dynamic badge
  - Generates coverage reports via `./gradlew koverXmlReport`
  - Coverage badge updated automatically on main branch builds
  - Badge displayed in README alongside build and security badges
- Scheduled security scan workflow (daily) with dynamic vulnerability badge
  - Runs Trivy scans on SBOMs daily at 6 AM UTC
  - Updates badge in `.github/badges/trivy.json` showing vulnerability count
  - Automatically creates GitHub issue when critical vulnerabilities are detected
- README badges for CI build status, security scan, and AGPL-3.0 license
- Manual trigger for Helm chart workflow via `workflow_dispatch` with optional `force_release` input
- Docker image signing with Cosign (keyless OIDC)
  - All published images are cryptographically signed using Sigstore
  - SBOM attestation attached to images using CycloneDX format
  - Verify signatures: `cosign verify ghcr.io/epistola-app/epistola-suite:<tag> --certificate-identity-regexp='.*' --certificate-oidc-issuer='https://token.actions.githubusercontent.com'`
  - Verify SBOM attestation: `cosign verify-attestation ghcr.io/epistola-app/epistola-suite:<tag> --type cyclonedx --certificate-identity-regexp='.*' --certificate-oidc-issuer='https://token.actions.githubusercontent.com'`
- Helm chart for Kubernetes deployment
  - Published to OCI registry at `oci://ghcr.io/epistola-app/charts/epistola`
  - Separate versioning from the application using `chart-X.Y.Z` tags
  - Automatic version bumping based on conventional commits for changes in `charts/` directory
  - Includes: Deployment, Service, Ingress (optional), HPA (optional), ServiceAccount, ConfigMap
  - Trivy security scanning for Kubernetes misconfigurations
  - Spring Boot Actuator health probes (liveness/readiness) configured
- SBOM (Software Bill of Materials) generation using CycloneDX
  - Backend SBOM: `./gradlew :apps:epistola:generateSbom`
  - Frontend SBOM: `./gradlew :modules:editor:npmSbom`
  - Both SBOMs attached to GitHub Releases (`epistola-backend-{version}-sbom.json`, `epistola-editor-{version}-sbom.json`)
  - Backend SBOM embedded in Docker images at `META-INF/sbom/bom.json`
- Automatic vulnerability scanning using Trivy
  - Scans both backend and frontend SBOMs on every build
  - Fails build on critical vulnerabilities
  - Vulnerability reports uploaded as CI artifacts
- GitHub Releases are now created automatically with release notes and SBOM attachment
- Open source community infrastructure
  - CONTRIBUTING.md with development workflow, commit conventions, and code style guidelines
  - CODE_OF_CONDUCT.md based on Contributor Covenant v2.1
  - SECURITY.md with vulnerability reporting guidelines and 48-hour response SLA
  - GitHub issue templates (bug report, feature request, documentation)
  - Pull request template with checklist
  - Issue template config linking to GitHub Discussions for questions
  - Automated label management via GitHub Actions (`.github/labels.yml`)
  - Comprehensive GitHub documentation (`docs/github.md`) covering CI/CD, releases, labels, and workflows
  - CLAUDE.md with project-specific instructions for Claude Code AI assistant
  - Git hooks with commitlint for conventional commit validation
  - SSH commit signing auto-configuration in init script
- Initial project setup with Spring Boot 4.0.0 and Kotlin 2.3.0
- Multi-module Gradle structure with apps/epistola and modules/editor
- Vite-based editor module with TypeScript, embeddable in the Java application
- GitHub Actions CI/CD pipeline with build, test, and Docker image publishing to ghcr.io
- Automatic semantic versioning using github-tag-action based on conventional commits
- ktlint for consistent code style
- README with getting started guide using mise for version management
