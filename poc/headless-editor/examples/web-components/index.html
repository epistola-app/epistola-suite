<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Headless Editor PoC - Web Components</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .block {
      border: 2px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      transition: all 0.15s;
      background: #fff;
    }
    .block:hover { border-color: #adb5bd; }
    .block.selected { border-color: #0d6efd; background: #e7f1ff; }
    .block.sortable-ghost { opacity: 0.4; border: 2px dashed #0d6efd; }
    .block.sortable-drag { box-shadow: 0 8px 20px rgba(0,0,0,0.2); transform: rotate(2deg); }
    .block.sortable-chosen { border-color: #0d6efd; }
    .block[data-block-type="columns"] {
      border-color: #6f42c1;
      background: #f8f5ff;
    }
    .block[data-block-type="columns"].selected {
      border-color: #6f42c1;
      background: #ede5ff;
    }
    .block[data-block-type="column"] {
      border-color: #6f42c1;
      border-style: dashed;
      background: #faf8ff;
    }
    .columns-layout {
      display: flex;
      gap: 0.5rem;
    }
    .columns-layout > .block {
      flex: 1;
      margin-bottom: 0;
    }
    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      cursor: grab;
      padding: 0.25rem;
      margin: -0.25rem -0.25rem 0.5rem -0.25rem;
      border-radius: 0.25rem;
    }
    .block-header:hover { background: rgba(0,0,0,0.03); }
    .block-header:active { cursor: grabbing; }
    .drag-handle { padding: 0 0.5rem; color: #adb5bd; }
    .block-children {
      margin-left: 1rem;
      padding-left: 1rem;
      border-left: 2px solid #dee2e6;
      margin-top: 0.5rem;
      min-height: 50px;
      transition: all 0.15s;
    }
    .state-display {
      font-family: monospace;
      font-size: 0.8rem;
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 0.375rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow: auto;
    }
    .callbacks-log {
      font-family: monospace;
      font-size: 0.75rem;
      max-height: 150px;
      overflow: auto;
      background: #212529;
      color: #20c997;
      padding: 0.5rem;
      border-radius: 0.375rem;
    }
    .callbacks-log div {
      padding: 2px 0;
      border-bottom: 1px solid #495057;
    }
    .empty-state {
      color: #6c757d;
      font-style: italic;
      text-align: center;
      padding: 2rem;
    }
    .block-list { min-height: 200px; }
    .toolbar-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    kbd {
      background: #212529;
      color: #fff;
      padding: 0.1rem 0.3rem;
      border-radius: 0.2rem;
      font-size: 0.75rem;
    }
    .btn-outline-purple {
      border-color: #6f42c1;
      color: #6f42c1;
    }
    .btn-outline-purple:hover {
      background-color: #6f42c1;
      color: #fff;
    }
    .bg-purple {
      background-color: #6f42c1;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-1">Headless Editor PoC - Web Components (Simplified)</h1>
    <p class="text-muted mb-4">
      Pure TypeScript logic + Custom Elements + SortableJS.
      <strong>Drag blocks to reorder!</strong>
      <kbd>Ctrl+Z</kbd> undo, <kbd>Ctrl+Shift+Z</kbd> redo
    </p>

    <div class="row g-4">
      <div class="col-md-8">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Editor</span>
            <small class="text-muted">Web Components + Headless Editor</small>
          </div>
          <div class="card-body">
            <div id="editor-container"></div>
          </div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card mb-3">
          <div class="card-header">Current State</div>
          <div class="card-body">
            <state-panel id="state-panel"></state-panel>
          </div>
        </div>

        <div class="card">
          <div class="card-header">Callbacks Log</div>
          <div class="card-body p-2">
            <log-panel id="log-panel"></log-panel>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { TemplateEditor } from '../../dist/editor.bundle.js';

    // Simple event bus for components
    class EventBus {
      constructor() {
        this.listeners = new Map();
      }
      on(event, callback) {
        if (!this.listeners.has(event)) this.listeners.set(event, []);
        this.listeners.get(event).push(callback);
      }
      emit(event, data) {
        const callbacks = this.listeners.get(event) || [];
        callbacks.forEach(cb => cb(data));
      }
    }

    const bus = new EventBus();

    // Create shared editor instance
    const editor = new TemplateEditor({
      template: { id: 'wc-template', name: 'Web Components Template', blocks: [] },
      callbacks: {
        onTemplateChange: (template) => bus.emit('template-change', template),
        onBlockSelect: (blockId) => bus.emit('block-select', blockId),
        onBeforeBlockAdd: (block, parentId) => {
          bus.emit('log', `Adding ${block.type} to ${parentId || 'root'}`);
          return true;
        },
        onBeforeBlockDelete: (blockId) => {
          bus.emit('log', `Deleting ${blockId}`);
          return true;
        },
        onError: (error) => bus.emit('log', `ERROR: ${error.message}`)
      }
    });

    // Helper functions
    function getBadgeClass(type) {
      switch (type) {
        case 'container': return 'bg-primary';
        case 'columns':
        case 'column': return 'bg-purple';
        default: return 'bg-secondary';
      }
    }

    function getBadgeStyle(type) {
      return (type === 'columns' || type === 'column') ? 'background-color: #6f42c1;' : '';
    }

    // Editor Container Component
    class EditorContainer extends HTMLElement {
      constructor() {
        super();
        this.sortableInstances = [];
      }

      connectedCallback() {
        this.innerHTML = `
          <div class="toolbar-section">
            <div class="btn-group">
              <button id="btn-add-text" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus"></i> Text
              </button>
              <button id="btn-add-container" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-plus"></i> Container
              </button>
              <button id="btn-add-columns" class="btn btn-outline-purple btn-sm">
                <i class="bi bi-layout-three-columns"></i> Columns
              </button>
            </div>
            <div class="btn-group">
              <button id="btn-undo" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="bi bi-arrow-counterclockwise"></i> Undo
              </button>
              <button id="btn-redo" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="bi bi-arrow-clockwise"></i> Redo
              </button>
            </div>
            <button id="btn-add-to-selected" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-plus"></i> Add to Selected
            </button>
          </div>
          <div id="block-list" class="block-list">
            <div class="empty-state">No blocks yet. Add one above.</div>
          </div>
        `;

        this.setupButtons();
        this.setupKeyboard();
        this.render();

        bus.on('template-change', () => this.render());
        bus.on('block-select', () => this.render());

        bus.emit('log', 'Editor initialized with Web Components');
      }

      setupButtons() {
        this.querySelector('#btn-add-text').onclick = () => editor.addBlock('text');
        this.querySelector('#btn-add-container').onclick = () => editor.addBlock('container');
        this.querySelector('#btn-add-columns').onclick = () => {
          const cols = editor.addBlock('columns');
          if (cols) {
            editor.addBlock('column', cols.id);
            editor.addBlock('column', cols.id);
          }
        };
        this.querySelector('#btn-undo').onclick = () => { if (editor.undo()) bus.emit('log', 'Undo'); };
        this.querySelector('#btn-redo').onclick = () => { if (editor.redo()) bus.emit('log', 'Redo'); };
        this.querySelector('#btn-add-to-selected').onclick = () => {
          const state = editor.getState();
          if (!state.selectedBlockId) {
            bus.emit('log', 'No block selected');
            return;
          }
          const block = editor.findBlock(state.selectedBlockId);
          if (block.type === 'columns') {
            if (block.children?.length >= 4) {
              bus.emit('log', 'Max 4 columns allowed');
              return;
            }
            editor.addBlock('column', state.selectedBlockId);
          } else if (['container', 'column'].includes(block.type)) {
            editor.addBlock('text', state.selectedBlockId);
          } else {
            bus.emit('log', `Cannot add children to ${block.type}`);
          }
        };
      }

      setupKeyboard() {
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey || e.metaKey) {
            if (e.key === 'z' && !e.shiftKey) {
              e.preventDefault();
              if (editor.undo()) bus.emit('log', 'Undo');
            } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
              e.preventDefault();
              if (editor.redo()) bus.emit('log', 'Redo');
            }
          }
        });
      }

      render() {
        const state = editor.getState();
        const list = this.querySelector('#block-list');

        // Cleanup sortables
        this.sortableInstances.forEach(s => s.destroy());
        this.sortableInstances = [];

        // Update button states
        this.querySelector('#btn-undo').disabled = !editor.canUndo();
        this.querySelector('#btn-redo').disabled = !editor.canRedo();

        // Render blocks
        list.innerHTML = '';
        if (state.template.blocks.length === 0) {
          list.innerHTML = '<div class="empty-state">No blocks yet. Add one above.</div>';
        } else {
          state.template.blocks.forEach(block => {
            list.appendChild(this.createBlockElement(block, state.selectedBlockId));
          });
        }

        this.setupSortable();
      }

      createBlockElement(block, selectedId) {
        const isSelected = selectedId === block.id;
        const el = document.createElement('div');
        el.className = `block ${isSelected ? 'selected' : ''}`;
        el.dataset.blockId = block.id;
        el.dataset.blockType = block.type;

        // Header
        const badgeClass = getBadgeClass(block.type);
        const badgeStyle = getBadgeStyle(block.type);

        let html = `
          <div class="block-header">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-grip-vertical drag-handle text-muted"></i>
              <span class="badge ${badgeClass}" style="${badgeStyle}">${block.type}</span>
            </div>
            <button class="btn btn-outline-danger btn-sm btn-delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;

        // Content
        if (block.type === 'text') {
          html += `<textarea class="form-control form-control-sm txt-content" placeholder="Enter text..." rows="2">${block.content || ''}</textarea>`;
        }

        if (block.type === 'container' && block.children) {
          const childrenHtml = block.children.length === 0
            ? '<div class="empty-state" style="padding: 0.5rem;">Drop blocks here</div>'
            : block.children.map(c => this.createBlockElement(c, selectedId).outerHTML).join('');
          html += `<div class="block-children sortable-container" data-parent-id="${block.id}">${childrenHtml}</div>`;
        }

        if (block.type === 'columns' && block.children) {
          const childrenHtml = block.children.length === 0
            ? '<div class="empty-state" style="padding: 0.5rem; flex: 1;">Add columns (max 4)</div>'
            : block.children.map(c => this.createBlockElement(c, selectedId).outerHTML).join('');
          html += `<div class="columns-layout sortable-container" data-parent-id="${block.id}">${childrenHtml}</div>`;
        }

        if (block.type === 'column' && block.children) {
          const childrenHtml = block.children.length === 0
            ? '<div class="empty-state" style="padding: 0.5rem;">Drop content here</div>'
            : block.children.map(c => this.createBlockElement(c, selectedId).outerHTML).join('');
          html += `<div class="block-children sortable-container" data-parent-id="${block.id}" style="margin-left: 0; padding-left: 0.5rem; border-left-color: #6f42c1;">${childrenHtml}</div>`;
        }

        el.innerHTML = html;

        // Events
        el.onclick = (e) => {
          if (e.target.closest('.btn-delete')) {
            e.stopPropagation();
            editor.deleteBlock(block.id);
          } else if (e.target.tagName === 'TEXTAREA') {
            e.stopPropagation();
          } else {
            editor.selectBlock(block.id);
          }
        };

        const textarea = el.querySelector('.txt-content');
        if (textarea) {
          textarea.oninput = (e) => editor.updateBlock(block.id, { content: e.target.value });
        }

        return el;
      }

      setupSortable() {
        const list = this.querySelector('#block-list');
        const dnd = editor.getDragDropPort();

        const handleDrop = (evt) => {
          const draggedId = evt.item.dataset.blockId;
          const toContainer = evt.to;
          const newIndex = evt.newIndex;
          let targetParentId = null;
          if (toContainer.classList.contains('sortable-container')) {
            targetParentId = toContainer.dataset.parentId;
          }

          bus.emit('log', `Drop: ${draggedId} -> ${targetParentId || 'root'} at ${newIndex}`);

          if (dnd.canDrop(draggedId, targetParentId, 'inside')) {
            editor.moveBlock(draggedId, targetParentId, newIndex);
            bus.emit('log', 'Drop accepted');
          } else {
            bus.emit('log', 'Invalid drop rejected');
            this.render();
          }
        };

        if (list.children.length > 0 && !list.querySelector('.empty-state')) {
          this.sortableInstances.push(new Sortable(list, {
            group: 'blocks', animation: 150, handle: '.block-header',
            ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag',
            fallbackOnBody: true, swapThreshold: 0.65, emptyInsertThreshold: 0,
            onEnd: handleDrop
          }));
        }

        this.querySelectorAll('.sortable-container').forEach(container => {
          this.sortableInstances.push(new Sortable(container, {
            group: 'blocks', animation: 150, handle: '.block-header',
            ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', dragClass: 'sortable-drag',
            fallbackOnBody: true, swapThreshold: 0.65, emptyInsertThreshold: 30,
            onEnd: handleDrop
          }));
        });
      }
    }

    // State Panel Component
    class StatePanel extends HTMLElement {
      connectedCallback() {
        this.className = 'state-display';
        this.update();
        bus.on('template-change', () => this.update());
        bus.on('block-select', () => this.update());
      }

      update() {
        const state = editor.getState();
        this.textContent = JSON.stringify({
          selectedBlockId: state.selectedBlockId,
          blockCount: state.template.blocks.length,
          canUndo: editor.canUndo(),
          canRedo: editor.canRedo(),
          template: state.template
        }, null, 2);
      }
    }

    // Log Panel Component
    class LogPanel extends HTMLElement {
      constructor() {
        super();
        this.logs = [];
        this.logId = 0;
      }

      connectedCallback() {
        this.className = 'callbacks-log';
        bus.on('log', (msg) => this.addLog(msg));
      }

      addLog(msg) {
        this.logs.unshift({ id: ++this.logId, message: `${new Date().toLocaleTimeString()}: ${msg}` });
        if (this.logs.length > 20) this.logs.pop();
        this.render();
      }

      render() {
        this.innerHTML = this.logs.map(l => `<div>${l.message}</div>`).join('');
      }
    }

    // Register components
    customElements.define('editor-container', EditorContainer);
    customElements.define('state-panel', StatePanel);
    customElements.define('log-panel', LogPanel);

    // Mount editor
    document.getElementById('editor-container').innerHTML = '<editor-container></editor-container>';
  </script>
</body>
</html>
