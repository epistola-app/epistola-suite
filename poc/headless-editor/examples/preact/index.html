<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Headless Editor PoC - Preact</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    .block {
      border: 2px solid #dee2e6;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      transition: all 0.15s;
      background: #fff;
    }
    .block:hover { border-color: #adb5bd; }
    .block.selected { border-color: #0d6efd; background: #e7f1ff; }
    .block.sortable-ghost { opacity: 0.4; border: 2px dashed #0d6efd; }
    .block.sortable-drag { box-shadow: 0 8px 20px rgba(0,0,0,0.2); transform: rotate(2deg); }
    .block.sortable-chosen { border-color: #0d6efd; }
    .block[data-block-type="columns"] {
      border-color: #6f42c1;
      background: #f8f5ff;
    }
    .block[data-block-type="columns"].selected {
      border-color: #6f42c1;
      background: #ede5ff;
    }
    .block[data-block-type="column"] {
      border-color: #6f42c1;
      border-style: dashed;
      background: #faf8ff;
    }
    .columns-layout {
      display: flex;
      gap: 0.5rem;
    }
    .columns-layout > .block {
      flex: 1;
      margin-bottom: 0;
    }
    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      cursor: grab;
      padding: 0.25rem;
      margin: -0.25rem -0.25rem 0.5rem -0.25rem;
      border-radius: 0.25rem;
    }
    .block-header:hover { background: rgba(0,0,0,0.03); }
    .block-header:active { cursor: grabbing; }
    .drag-handle { padding: 0 0.5rem; color: #adb5bd; }
    .block-children {
      margin-left: 1rem;
      padding-left: 1rem;
      border-left: 2px solid #dee2e6;
      margin-top: 0.5rem;
      min-height: 50px;
      transition: all 0.15s;
    }
    .state-display {
      font-family: monospace;
      font-size: 0.8rem;
      background: #f8f9fa;
      padding: 0.75rem;
      border-radius: 0.375rem;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 300px;
      overflow: auto;
    }
    .callbacks-log {
      font-family: monospace;
      font-size: 0.75rem;
      max-height: 150px;
      overflow: auto;
      background: #212529;
      color: #20c997;
      padding: 0.5rem;
      border-radius: 0.375rem;
    }
    .callbacks-log div {
      padding: 2px 0;
      border-bottom: 1px solid #495057;
    }
    .empty-state {
      color: #6c757d;
      font-style: italic;
      text-align: center;
      padding: 2rem;
    }
    .block-list { min-height: 200px; }
    .toolbar-section {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    kbd {
      background: #212529;
      color: #fff;
      padding: 0.1rem 0.3rem;
      border-radius: 0.2rem;
      font-size: 0.75rem;
    }
    .btn-outline-purple {
      border-color: #6f42c1;
      color: #6f42c1;
    }
    .btn-outline-purple:hover {
      background-color: #6f42c1;
      color: #fff;
    }
    .bg-purple {
      background-color: #6f42c1;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { h, render, Component } from 'https://esm.sh/preact@10.19.3';
    import { useState, useEffect, useRef } from 'https://esm.sh/preact@10.19.3/hooks';
    import htm from 'https://esm.sh/htm@3.1.1';
    import { TemplateEditor } from '../../dist/editor.bundle.js';

    const html = htm.bind(h);

    // Global editor state
    let editor = null;
    let updateCallbacks = new Set();

    function getEditor() {
      if (!editor) {
        editor = new TemplateEditor({
          template: { id: 'preact-template', name: 'Preact Template', blocks: [] },
          callbacks: {
            onTemplateChange: () => notifyUpdate(),
            onBlockSelect: () => notifyUpdate(),
          }
        });
      }
      return editor;
    }

    function notifyUpdate() {
      updateCallbacks.forEach(cb => cb());
    }

    function useEditor() {
      const [, forceUpdate] = useState({});
      
      useEffect(() => {
        const cb = () => forceUpdate({});
        updateCallbacks.add(cb);
        return () => updateCallbacks.delete(cb);
      }, []);

      return getEditor();
    }

    function Toolbar({ onAddBlock, onAddColumns, onAddToSelected, onUndo, onRedo, canUndo, canRedo }) {
      return html`
        <div class="toolbar-section">
          <div class="btn-group">
            <button onClick=${() => onAddBlock('text')} class="btn btn-outline-primary btn-sm">
              <i class="bi bi-plus"></i> Text
            </button>
            <button onClick=${() => onAddBlock('container')} class="btn btn-outline-primary btn-sm">
              <i class="bi bi-plus"></i> Container
            </button>
            <button onClick=${onAddColumns} class="btn btn-outline-purple btn-sm">
              <i class="bi bi-layout-three-columns"></i> Columns
            </button>
          </div>

          <div class="btn-group">
            <button onClick=${onUndo} class="btn btn-outline-secondary btn-sm" disabled=${!canUndo}>
              <i class="bi bi-arrow-counterclockwise"></i> Undo
            </button>
            <button onClick=${onRedo} class="btn btn-outline-secondary btn-sm" disabled=${!canRedo}>
              <i class="bi bi-arrow-clockwise"></i> Redo
            </button>
          </div>

          <button onClick=${onAddToSelected} class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-plus"></i> Add to Selected
          </button>
        </div>
      `;
    }

    function getBadgeClass(type) {
      switch (type) {
        case 'container': return 'bg-primary';
        case 'columns':
        case 'column': return 'bg-purple';
        default: return 'bg-secondary';
      }
    }

    function getBadgeStyle(type) {
      return (type === 'columns' || type === 'column') ? 'background-color: #6f42c1;' : '';
    }

    function Block({ block, selectedId, editor }) {
      const isSelected = selectedId === block.id;
      const badgeClass = getBadgeClass(block.type);
      const badgeStyle = getBadgeStyle(block.type);

      const handleSelect = (e) => {
        e.stopPropagation();
        editor.selectBlock(block.id);
      };

      const handleDelete = (e) => {
        e.stopPropagation();
        editor.deleteBlock(block.id);
      };

      const handleTextChange = (e) => {
        editor.updateBlock(block.id, { content: e.target.value });
      };

      let content = null;

      if (block.type === 'text') {
        content = html`
          <textarea class="form-control form-control-sm" 
                    placeholder="Enter text..." rows="2"
                    onClick=${e => e.stopPropagation()}
                    onInput=${handleTextChange}>${block.content || ''}</textarea>
        `;
      }

      if (block.type === 'container' && block.children) {
        content = html`
          <div class="block-children sortable-container" data-parent-id="${block.id}">
            ${block.children.length === 0
              ? html`<div class="empty-state" style="padding: 0.5rem;">Drop blocks here</div>`
              : block.children.map(child => html`<${Block} key=${child.id} block=${child} selectedId=${selectedId} editor=${editor} />`)
            }
          </div>
        `;
      }

      if (block.type === 'columns' && block.children) {
        content = html`
          <div class="columns-layout sortable-container" data-parent-id="${block.id}">
            ${block.children.length === 0
              ? html`<div class="empty-state" style="padding: 0.5rem; flex: 1;">Add columns (max 4)</div>`
              : block.children.map(child => html`<${Block} key=${child.id} block=${child} selectedId=${selectedId} editor=${editor} />`)
            }
          </div>
        `;
      }

      if (block.type === 'column' && block.children) {
        content = html`
          <div class="block-children sortable-container" data-parent-id="${block.id}" 
               style="margin-left: 0; padding-left: 0.5rem; border-left-color: #6f42c1;">
            ${block.children.length === 0
              ? html`<div class="empty-state" style="padding: 0.5rem;">Drop content here</div>`
              : block.children.map(child => html`<${Block} key=${child.id} block=${child} selectedId=${selectedId} editor=${editor} />`)
            }
          </div>
        `;
      }

      return html`
        <div class="block ${isSelected ? 'selected' : ''}" 
             data-block-id="${block.id}" data-block-type="${block.type}"
             onClick=${handleSelect}>
          <div class="block-header">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-grip-vertical drag-handle text-muted"></i>
              <span class="badge ${badgeClass}" style="${badgeStyle}">${block.type}</span>
            </div>
            <button class="btn btn-outline-danger btn-sm" onClick=${handleDelete}>
              <i class="bi bi-trash"></i>
            </button>
          </div>
          ${content}
        </div>
      `;
    }

    function Editor() {
      const editor = useEditor();
      const state = editor.getState();
      const blockListRef = useRef(null);
      const sortableInstancesRef = useRef([]);
      const [logs, setLogs] = useState([]);
      const logIdRef = useRef(0);

      const addLog = (msg) => {
        const newLog = { id: ++logIdRef.current, message: `${new Date().toLocaleTimeString()}: ${msg}` };
        setLogs(prev => [newLog, ...prev].slice(0, 20));
      };

      useEffect(() => {
        addLog('Editor initialized with Preact');

        const handleKeyDown = (e) => {
          if (e.ctrlKey || e.metaKey) {
            if (e.key === 'z' && !e.shiftKey) {
              e.preventDefault();
              if (editor.undo()) {
                addLog('Undo');
              }
            } else if ((e.key === 'z' && e.shiftKey) || e.key === 'y') {
              e.preventDefault();
              if (editor.redo()) {
                addLog('Redo');
              }
            }
          }
        };

        document.addEventListener('keydown', handleKeyDown);
        return () => document.removeEventListener('keydown', handleKeyDown);
      }, []);

      // Initialize sortables after render
      useEffect(() => {
        // Need to wait for DOM to be ready
        const timeoutId = setTimeout(() => {
          const rootContainer = blockListRef.current;
          if (!rootContainer) return;

          // Clean up any existing sortables first
          sortableInstancesRef.current.forEach(s => {
            try { s.destroy(); } catch(e) {}
          });
          sortableInstancesRef.current = [];

          const dnd = editor.getDragDropPort();

          const handleDrop = (evt) => {
            const draggedId = evt.item.dataset.blockId;
            const toContainer = evt.to;
            const newIndex = evt.newIndex;
            let targetParentId = null;

            if (toContainer.classList.contains('sortable-container')) {
              targetParentId = toContainer.dataset.parentId;
            }

            addLog(`Drop: ${draggedId} -> ${targetParentId || 'root'} at ${newIndex}`);

            if (dnd.canDrop(draggedId, targetParentId, 'inside')) {
              editor.moveBlock(draggedId, targetParentId, newIndex);
              addLog('Drop accepted');
            } else {
              addLog('Invalid drop rejected');
            }
          };

          // Root sortable
          if (state.template.blocks.length > 0) {
            sortableInstancesRef.current.push(new Sortable(rootContainer, {
              group: 'blocks',
              animation: 150,
              handle: '.block-header',
              ghostClass: 'sortable-ghost',
              chosenClass: 'sortable-chosen',
              dragClass: 'sortable-drag',
              fallbackOnBody: true,
              swapThreshold: 0.65,
              emptyInsertThreshold: 0,
              onEnd: handleDrop
            }));
          }

          // Nested sortables
          rootContainer.querySelectorAll('.sortable-container').forEach(container => {
            sortableInstancesRef.current.push(new Sortable(container, {
              group: 'blocks',
              animation: 150,
              handle: '.block-header',
              ghostClass: 'sortable-ghost',
              chosenClass: 'sortable-chosen',
              dragClass: 'sortable-drag',
              fallbackOnBody: true,
              swapThreshold: 0.65,
              emptyInsertThreshold: 30,
              onEnd: handleDrop
            }));
          });
        }, 50);

        return () => {
          clearTimeout(timeoutId);
          sortableInstancesRef.current.forEach(s => {
            try { s.destroy(); } catch(e) {}
          });
        };
      }, [state.template.blocks.length, state.selectedBlockId]);

      const handleAddBlock = (type) => {
        addLog(`Adding ${type}`);
        editor.addBlock(type);
      };

      const handleAddColumns = () => {
        addLog('Adding columns with 2 columns');
        const columns = editor.addBlock('columns');
        if (columns) {
          editor.addBlock('column', columns.id);
          editor.addBlock('column', columns.id);
        }
      };

      const handleAddToSelected = () => {
        if (!state.selectedBlockId) {
          addLog('No block selected');
          return;
        }
        const block = editor.findBlock(state.selectedBlockId);
        if (!block) return;

        if (block.type === 'columns') {
          if (block.children?.length >= 4) {
            addLog('Max 4 columns allowed');
            return;
          }
          editor.addBlock('column', state.selectedBlockId);
        } else if (block.type === 'container' || block.type === 'column') {
          editor.addBlock('text', state.selectedBlockId);
        } else {
          addLog(`Cannot add children to ${block.type}`);
        }
      };

      const handleUndo = () => {
        if (editor.undo()) {
          addLog('Undo');
        }
      };

      const handleRedo = () => {
        if (editor.redo()) {
          addLog('Redo');
        }
      };

      return html`
        <div class="container py-4">
          <h1 class="mb-1">Headless Editor PoC - Preact</h1>
          <p class="text-muted mb-4">
            Pure TypeScript logic + Preact + SortableJS.
            <strong>Drag blocks to reorder!</strong>
            <kbd>Ctrl+Z</kbd> undo, <kbd>Ctrl+Shift+Z</kbd> redo
          </p>

          <div class="row g-4">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span>Editor</span>
                  <small class="text-muted">Preact + Headless Editor</small>
                </div>
                <div class="card-body">
                  <${Toolbar} 
                    onAddBlock=${handleAddBlock}
                    onAddColumns=${handleAddColumns}
                    onAddToSelected=${handleAddToSelected}
                    onUndo=${handleUndo}
                    onRedo=${handleRedo}
                    canUndo=${editor.canUndo()}
                    canRedo=${editor.canRedo()}
                  />
                  <div ref=${blockListRef} class="block-list">
                    ${state.template.blocks.length === 0
                      ? html`<div class="empty-state">No blocks yet. Add one above.</div>`
                      : state.template.blocks.map(block => html`<${Block} key=${block.id} block=${block} selectedId=${state.selectedBlockId} editor=${editor} />`)
                    }
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card mb-3">
                <div class="card-header">Current State</div>
                <div class="card-body">
                  <div class="state-display">${JSON.stringify({
                    selectedBlockId: state.selectedBlockId,
                    blockCount: state.template.blocks.length,
                    canUndo: editor.canUndo(),
                    canRedo: editor.canRedo(),
                    template: state.template
                  }, null, 2)}</div>
                </div>
              </div>

              <div class="card">
                <div class="card-header">Callbacks Log</div>
                <div class="card-body p-2">
                  <div class="callbacks-log">
                    ${logs.map(log => html`<div key=${log.id}>${log.message}</div>`)}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    render(html`<${Editor} />`, document.getElementById('root'));
  </script>
</body>
</html>
