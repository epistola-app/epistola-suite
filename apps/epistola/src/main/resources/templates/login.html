<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${param.popup != null} ? 'Log In - Epistola' : 'Login - Epistola Suite'">Login - Epistola Suite</title>
    <th:block th:replace="~{fragments/styles :: styles}" />
</head>
<body>
    <div class="login-container">
        <div class="login-card" th:classappend="${param.popup != null} ? 'popup-mode' : ''">
            <div class="login-header">
                <h1>Epistola Suite</h1>
                <p th:unless="${param.popup != null}">Document Management System</p>
                <p th:if="${param.popup != null}">Session Expired</p>
            </div>

            <!-- Popup mode notice -->
            <div th:if="${param.popup != null}" class="alert alert-info" style="margin-bottom: var(--ep-space-6);">
                Your session has expired. Please log in again to continue.
            </div>

            <!-- Error message -->
            <div th:if="${param.error}" class="alert alert-error">
                <p>Invalid username or password. Please try again.</p>
            </div>

            <!-- Logout success message (don't show in popup mode) -->
            <div th:if="${param.logout != null and param.popup == null}" class="alert alert-success">
                <p>You have been logged out successfully.</p>
            </div>

            <!-- Form login (shown when local profile is active) -->
            <div th:if="${hasFormLogin}">
                <form th:action="@{/login}" method="post">
                    <!-- Hidden field to preserve popup mode through form POST -->
                    <input th:if="${param.popup != null}" type="hidden" name="popup" value="true">
                    <div class="form-group">
                        <label for="username">Email</label>
                        <input type="text" id="username" name="username" required autofocus placeholder="admin@local">
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required placeholder="Password">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <th:block th:replace="~{fragments/icon :: icon(name='log-in', class='ep-icon')}" />
                        Sign In
                    </button>
                </form>

                <div th:unless="${param.popup != null}" class="alert alert-warning" style="margin-top: var(--ep-space-6);">
                    <div>
                        <strong>Local Development Mode</strong><br>
                        Test accounts:<br>
                        &bull; admin@local / admin<br>
                        &bull; user@local / user
                    </div>
                </div>
            </div>

            <!-- Divider when both login methods are available -->
            <div th:if="${hasFormLogin and hasOAuth2}" class="login-divider">
                <span>or</span>
            </div>

            <!-- OAuth2 login (shown when OAuth2 is configured) -->
            <div th:if="${hasOAuth2}">
                <a th:href="@{/oauth2/authorization/{id}(id=${oauth2RegistrationId}, popup=${param.popup != null ? 'true' : null})}"
                   class="btn btn-outline" style="width: 100%;">
                    Sign in with SSO
                </a>
            </div>
        </div>
    </div>
</body>
</html>
