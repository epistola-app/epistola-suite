<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
    <th:block th:fragment="content">
        <link rel="stylesheet" th:href="@{/schema-manager/schema-manager.css}">
        <script th:src="@{/js/pdf-preview.js}"></script>

        <div class="page-header">
            <div>
                <a th:href="@{/tenants/{tenantId}/templates(tenantId=${tenantId})}" class="back-link">&larr; Templates</a>
                <h1 th:text="${template.name}">Template Name</h1>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-nav-item active" data-tab="variants" onclick="switchTab('variants')">Variants</button>
            <button class="tab-nav-item" data-tab="data-contract" onclick="switchTab('data-contract')">Data Contract</button>
            <button class="tab-nav-item" data-tab="settings" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Tab Panel: Variants -->
        <div id="tab-variants" class="tab-panel active">
            <!-- Toggle button for create variant form -->
            <div style="margin-bottom: var(--ep-space-4);">
                <button type="button" class="btn btn-sm btn-primary" onclick="toggleCreateVariantForm()">+ New Variant</button>
            </div>

            <!-- Inline create variant form (hidden by default) -->
            <div id="create-variant-form" class="detail-section" style="display: none; margin-bottom: var(--ep-space-4);">
                <div class="detail-section-header">
                    <h3>Create Variant</h3>
                </div>
                <div class="detail-section-body">
                    <form th:action="@{/tenants/{tenantId}/templates/{id}/variants(tenantId=${tenantId},id=${template.id})}"
                          method="post"
                          th:hx-post="@{/tenants/{tenantId}/templates/{id}/variants(tenantId=${tenantId},id=${template.id})}"
                          hx-target="#variants-section"
                          hx-swap="outerHTML"
                          hx-on::after-request="if(event.detail.successful) { this.reset(); toggleCreateVariantForm(); }">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="ep-label" for="slug">Slug (ID)</label>
                                <input type="text" id="slug" name="slug" class="ep-input" required
                                       pattern="[a-z][a-z0-9]*(-[a-z0-9]+)*"
                                       placeholder="english-newsletter">
                                <span class="form-hint">URL-safe identifier (lowercase, hyphens allowed)</span>
                            </div>
                            <div class="form-group">
                                <label class="ep-label" for="title">Title (optional)</label>
                                <input type="text" id="title" name="title" class="ep-input" placeholder="English Newsletter">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="ep-label" for="tags">Tags (optional, format: key=value, one per line)</label>
                            <textarea id="tags" name="tags" class="ep-textarea" rows="2" placeholder="locale=en-US&#10;brand=default"></textarea>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn btn-primary">Create Variant</button>
                            <button type="button" class="btn btn-ghost" onclick="toggleCreateVariantForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Variants table -->
            <div id="variants-section" th:fragment="variants-section">
                <div th:if="${!#lists.isEmpty(variants)}" class="detail-section">
                    <div class="detail-section-body no-padding">
                        <table class="ep-table">
                            <thead>
                                <tr>
                                    <th style="width: 2rem;"></th>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Tags</th>
                                    <th>Published</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody th:each="variant : ${variants}">
                                <tr>
                                    <td>
                                        <button class="expand-toggle"
                                                th:data-variant-id="${variant.id}"
                                                th:data-versions-url="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/versions(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                                onclick="toggleVariant(this)"
                                                title="Show versions">&#9654;</button>
                                    </td>
                                    <td><code th:text="${variant.id}" style="font-size: var(--ep-text-xs);"></code></td>
                                    <td>
                                        <span th:if="${variant.title != null}" th:text="${variant.title}"></span>
                                        <span th:unless="${variant.title != null}" class="text-muted">-</span>
                                    </td>
                                    <td>
                                        <div class="tags" th:if="${!variant.tags.isEmpty()}">
                                            <span th:each="entry : ${variant.tags}"
                                                  class="badge badge-outline"
                                                  th:text="${entry.key + '=' + entry.value}"></span>
                                        </div>
                                        <span th:if="${variant.tags.isEmpty()}" class="text-muted">(default)</span>
                                    </td>
                                    <td>
                                        <th:block th:if="${!variant.publishedVersions.isEmpty()}">
                                            <span th:each="ver, iterStat : ${variant.publishedVersions}"><span class="badge badge-success" th:text="'v' + ${ver}"></span> </span>
                                        </th:block>
                                        <span th:if="${variant.publishedVersions.isEmpty()}" class="text-muted">-</span>
                                    </td>
                                    <td class="actions">
                                        <a th:href="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/editor(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                           class="btn btn-sm btn-icon btn-ghost" hx-boost="false" title="Open editor">
                                            <th:block th:replace="~{fragments/icon :: icon(name='pencil', class='ep-icon ep-icon-sm')}" />
                                        </a>
                                        <button type="button" class="btn btn-sm btn-icon btn-ghost"
                                                th:hx-get="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/edit(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                                hx-target="#edit-variant-dialog-body"
                                                hx-swap="innerHTML"
                                                onclick="document.getElementById('edit-variant-dialog').showModal()"
                                                title="Edit variant">
                                            <th:block th:replace="~{fragments/icon :: icon(name='settings', class='ep-icon ep-icon-sm')}" />
                                        </button>
                                        <form th:action="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/delete(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                              method="post"
                                              th:hx-delete="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                              hx-confirm="Are you sure you want to delete this variant?"
                                              hx-target="#variants-section"
                                              hx-swap="outerHTML">
                                            <button type="submit" class="btn btn-sm btn-icon btn-ghost btn-ghost-destructive" title="Delete variant">
                                                <th:block th:replace="~{fragments/icon :: icon(name='trash-2', class='ep-icon ep-icon-sm')}" />
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                <!-- Expandable detail row for versions -->
                                <tr class="variant-detail-row" th:id="'variant-detail-' + ${variant.id}" style="display: none;">
                                    <td th:colspan="6">
                                        <div class="variant-detail-content"
                                             th:id="'variant-versions-' + ${variant.id}">
                                            <!-- Versions loaded lazily via HTMX on first expand -->
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(variants)}" class="detail-section">
                    <div class="detail-section-body">
                        <div class="empty-state" style="padding: var(--ep-space-8);">
                            <div class="empty-state-title">No variants yet</div>
                            <div class="empty-state-description">Create a variant to start designing your template.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit variant dialog -->
            <dialog id="edit-variant-dialog" class="ep-dialog">
                <div id="edit-variant-dialog-body">
                    <!-- Content loaded via HTMX -->
                </div>
            </dialog>
        </div>

        <!-- Tab Panel: Data Contract -->
        <div id="tab-data-contract" class="tab-panel">
            <div class="detail-section">
                <div class="detail-section-header">
                    <h3>Data Contract</h3>
                </div>
                <div class="detail-section-body">
                    <p class="text-muted" style="margin-bottom: var(--ep-space-4); font-size: var(--ep-text-sm);">
                        Define the JSON schema and test data examples for this template.
                    </p>
                    <div id="schema-manager-container"></div>
                </div>
            </div>
        </div>

        <!-- Tab Panel: Settings -->
        <div id="tab-settings" class="tab-panel">
            <!-- Details -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <h3>Details</h3>
                </div>
                <div class="detail-section-body">
                    <dl class="description-list">
                        <dt>ID</dt>
                        <dd><code th:text="${template.id}"></code></dd>
                        <dt>Created</dt>
                        <dd th:text="${#temporals.format(template.createdAt, 'yyyy-MM-dd HH:mm')}"></dd>
                        <dt>Modified</dt>
                        <dd th:text="${#temporals.format(template.lastModified, 'yyyy-MM-dd HH:mm')}"></dd>
                    </dl>
                </div>
            </div>

            <!-- Default Theme -->
            <div class="detail-section" id="theme-section" th:fragment="theme-section">
                <div class="detail-section-header">
                    <h3>Default Theme</h3>
                </div>
                <div class="detail-section-body">
                    <p class="text-muted" style="margin-bottom: var(--ep-space-4); font-size: var(--ep-text-sm);">
                        Set the default theme for all variants. Individual variants can override this in the editor.
                    </p>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <select id="theme-select"
                                    name="themeId"
                                    class="ep-select"
                                    onchange="updateTheme(this)">
                                <option value="">No theme (use variant defaults)</option>
                                <option th:each="theme : ${themes}"
                                        th:value="${theme.id}"
                                        th:text="${theme.name}"
                                        th:selected="${template.themeId != null and template.themeId.equals(theme.id)}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="detail-section danger-zone">
                <div class="detail-section-header">
                    <h3>Danger Zone</h3>
                </div>
                <div class="detail-section-body">
                    <p class="text-muted" style="margin-bottom: var(--ep-space-4); font-size: var(--ep-text-sm);">
                        Permanently delete this template and all its variants, versions, and data.
                    </p>
                    <form th:action="@{/tenants/{tenantId}/templates/{id}/delete(tenantId=${tenantId},id=${template.id})}"
                          method="post"
                          onsubmit="return confirm('Are you sure you want to delete this template? This action cannot be undone.')">
                        <button type="submit" class="btn btn-sm btn-destructive">Delete Template</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script th:inline="javascript">
            const TENANT_ID = [[${tenantId}]];
            const TEMPLATE_ID = [[${template.id}]];
            const INITIAL_SCHEMA = [[${template.dataModel}]];
            const INITIAL_EXAMPLES = [[${template.dataExamples}]];

            function updateTheme(select) {
                const themeId = select.value || null;
                const clearThemeId = !select.value;
                const url = [[${'/tenants/' + tenantId + '/templates/' + template.id + '/theme'}]];
                const csrfToken = typeof window.getCsrfToken === 'function' ? window.getCsrfToken() : '';

                fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-XSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({ themeId: themeId, clearThemeId: clearThemeId })
                })
                .then(response => response.text())
                .then(html => {
                    const section = document.getElementById('theme-section');
                    section.outerHTML = html;
                });
            }

            function switchTab(tabId) {
                document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
                document.getElementById('tab-' + tabId).classList.add('active');
            }

            function toggleCreateVariantForm() {
                const form = document.getElementById('create-variant-form');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }

            function toggleVariant(button) {
                const variantId = button.dataset.variantId;
                const versionsUrl = button.dataset.versionsUrl;
                const detailRow = document.getElementById('variant-detail-' + variantId);
                const isExpanded = detailRow.style.display !== 'none';
                detailRow.style.display = isExpanded ? 'none' : 'table-row';
                button.classList.toggle('expanded', !isExpanded);
                // Lazy load on first expand
                const container = document.getElementById('variant-versions-' + variantId);
                if (!isExpanded && !container.dataset.loaded) {
                    htmx.ajax('GET', versionsUrl, { target: container, swap: 'innerHTML' });
                    container.dataset.loaded = 'true';
                }
            }
        </script>
        <script type="module">
            import { mountSchemaManager } from '/schema-manager/schema-manager.js';

            const tenantId = TENANT_ID;
            const templateId = TEMPLATE_ID;
            const initialSchema = INITIAL_SCHEMA;
            const initialExamples = INITIAL_EXAMPLES;

            const manager = mountSchemaManager({
                container: document.getElementById('schema-manager-container'),
                templateId: templateId,
                initialSchema: initialSchema,
                initialExamples: initialExamples,
                callbacks: {
                    onSaveSchema: async (schema, forceUpdate) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-XSRF-TOKEN': window.getCsrfToken()
                                },
                                body: JSON.stringify({ dataModel: schema, forceUpdate })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                return { success: false, error: error.message, warnings: error.warnings };
                            }

                            const result = await response.json();
                            return { success: true, warnings: result.warnings };
                        } catch (error) {
                            console.error('Failed to save schema:', error);
                            return { success: false, error: error.message };
                        }
                    },

                    onSaveDataExamples: async (examples) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-XSRF-TOKEN': window.getCsrfToken()
                                },
                                body: JSON.stringify({ dataExamples: examples })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                return { success: false, warnings: error.warnings };
                            }

                            const result = await response.json();
                            return { success: true, warnings: result.warnings };
                        } catch (error) {
                            console.error('Failed to save examples:', error);
                            return { success: false };
                        }
                    },

                    onUpdateDataExample: async (exampleId, updates, forceUpdate) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}/data-examples/${exampleId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-XSRF-TOKEN': window.getCsrfToken()
                                },
                                body: JSON.stringify({ ...updates, forceUpdate })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                return { success: false, errors: error.errors, warnings: error.warnings };
                            }

                            const result = await response.json();
                            return { success: true, example: result, warnings: result.warnings };
                        } catch (error) {
                            console.error('Failed to update example:', error);
                            return { success: false };
                        }
                    },

                    onDeleteDataExample: async (exampleId) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}/data-examples/${exampleId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-XSRF-TOKEN': window.getCsrfToken()
                                }
                            });

                            return { success: response.ok };
                        } catch (error) {
                            console.error('Failed to delete example:', error);
                            return { success: false };
                        }
                    },

                    onValidateSchema: async (schema, examples) => {
                        return { compatible: true, errors: [], migrations: [] };
                    }
                }
            });
        </script>
    </th:block>

    <!-- Fragment: edit variant form (loaded into dialog via HTMX) -->
    <th:block th:fragment="edit-variant-form">
        <div class="ep-dialog-header">
            <h3>Edit Variant: <code th:text="${variant.id}"></code></h3>
        </div>
        <form th:hx-patch="@{/tenants/{tenantId}/templates/{templateId}/variants/{variantId}(tenantId=${tenantId},templateId=${templateId ?: template.id},variantId=${variant.id})}"
              hx-target="#variants-section"
              hx-swap="outerHTML"
              hx-on::after-request="if(event.detail.successful) document.getElementById('edit-variant-dialog').close()">
            <div class="ep-dialog-body">
                <div class="form-group">
                    <label class="ep-label" for="edit-variant-title">Title</label>
                    <input type="text" id="edit-variant-title" name="title" class="ep-input"
                           th:value="${variant.title}" placeholder="e.g. English Newsletter">
                </div>
                <div class="form-group">
                    <label class="ep-label" for="edit-variant-tags">Tags (key=value, one per line)</label>
                    <textarea id="edit-variant-tags" name="tags" class="ep-textarea" rows="3"
                              placeholder="locale=en&#10;brand=default"
                              th:text="${variant.tags != null ? #strings.listJoin(variant.tags.entrySet().![key + '=' + value], '&#10;') : ''}"></textarea>
                </div>
            </div>
            <div class="ep-dialog-footer">
                <button type="button" class="btn btn-ghost"
                        onclick="document.getElementById('edit-variant-dialog').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </th:block>
</body>
</html>
