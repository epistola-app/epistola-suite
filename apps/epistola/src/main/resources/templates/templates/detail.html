<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>
    <th:block th:fragment="content">
        <link rel="stylesheet" th:href="@{/editor/data-contract-editor.css}">
        <script th:src="@{/js/pdf-preview.js}"></script>

        <div class="page-header">
            <div>
                <a th:href="@{/tenants/{tenantId}/templates(tenantId=${tenantId})}" class="back-link">&larr; Templates</a>
                <h1 th:text="${template.name}">Template Name</h1>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-nav-item active" data-tab="variants" onclick="switchTab('variants')">Variants</button>
            <button class="tab-nav-item" data-tab="deployments" onclick="switchTab('deployments')">Deployments</button>
            <button class="tab-nav-item" data-tab="data-contract" onclick="switchTab('data-contract')">Data Contract</button>
            <button class="tab-nav-item" data-tab="settings" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- Tab Panel: Variants -->
        <div id="tab-variants" class="tab-panel active">
            <!-- Toggle button for create variant form -->
            <div style="margin-bottom: var(--ep-space-4);">
                <button type="button" class="btn btn-sm btn-primary" onclick="toggleCreateVariantForm()">+ New Variant</button>
            </div>

            <!-- Inline create variant form (hidden by default) -->
            <div id="create-variant-form" class="detail-section" style="display: none; margin-bottom: var(--ep-space-4);">
                <div class="detail-section-header">
                    <h3>Create Variant</h3>
                </div>
                <div class="detail-section-body">
                    <form th:action="@{/tenants/{tenantId}/templates/{id}/variants(tenantId=${tenantId},id=${template.id})}"
                          method="post"
                          th:hx-post="@{/tenants/{tenantId}/templates/{id}/variants(tenantId=${tenantId},id=${template.id})}"
                          hx-target="#variants-section"
                          hx-swap="outerHTML"
                          hx-on::after-request="if(event.detail.successful) { this.reset(); toggleCreateVariantForm(); }">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="ep-label" for="slug">Slug (ID)</label>
                                <input type="text" id="slug" name="slug" class="ep-input" required
                                       pattern="[a-z][a-z0-9]*(-[a-z0-9]+)*"
                                       placeholder="english-newsletter">
                                <span class="form-hint">URL-safe identifier (lowercase, hyphens allowed)</span>
                            </div>
                            <div class="form-group">
                                <label class="ep-label" for="title">Title (optional)</label>
                                <input type="text" id="title" name="title" class="ep-input" placeholder="English Newsletter">
                            </div>
                        </div>
                        <div class="form-row" th:if="${attributeDefinitions != null and !#lists.isEmpty(attributeDefinitions)}">
                            <div class="form-group" th:each="attrDef : ${attributeDefinitions}">
                                <label class="ep-label" th:for="'create-attr_' + ${attrDef.id}" th:text="${attrDef.displayName}"></label>
                                <select th:id="'create-attr_' + ${attrDef.id}" th:name="'attr_' + ${attrDef.id}" class="ep-select">
                                    <option value="">- Not set -</option>
                                    <option th:if="${!attrDef.allowedValues.isEmpty()}"
                                            th:each="val : ${attrDef.allowedValues}"
                                            th:value="${val}"
                                            th:text="${val}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="actions">
                            <button type="submit" class="btn btn-primary">Create Variant</button>
                            <button type="button" class="btn btn-ghost" onclick="toggleCreateVariantForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Attribute filter bar (outside variants-section to survive HTMX swaps) -->
            <div id="variant-filter-bar" class="variant-filter-bar"
                 th:if="${attributeDefinitions != null and !#lists.isEmpty(attributeDefinitions)}">
                <div class="form-group" th:each="attrDef : ${attributeDefinitions}">
                    <label th:text="${attrDef.displayName}"></label>
                    <select class="ep-select" th:data-filter-key="${attrDef.id}" onchange="filterVariants()">
                        <option value="">All</option>
                        <option th:each="val : ${attrDef.allowedValues}" th:value="${val}" th:text="${val}"></option>
                    </select>
                </div>
            </div>

            <!-- Variant card grid -->
            <div id="variants-section" th:fragment="variants-section">
                <div th:if="${variantError != null}" class="alert alert-error" style="margin-bottom: var(--ep-space-4);">
                    <span th:text="${variantError}"></span>
                </div>
                <div th:if="${!#lists.isEmpty(variants)}" class="variant-grid">
                    <div th:each="variant : ${variants}"
                         class="variant-card"
                         th:classappend="${variant.isDefault} ? 'variant-card-default'"
                         th:data-variant-id="${variant.id}">
                        <!-- Header: title + default badge -->
                        <div class="variant-card-header">
                            <div>
                                <span class="variant-card-title"
                                      th:text="${variant.title != null ? variant.title : variant.id}"></span>
                                <code th:if="${variant.title != null}" class="variant-card-slug"
                                      th:text="${variant.id}"></code>
                            </div>
                            <span th:if="${variant.isDefault}" class="badge badge-primary">Default</span>
                        </div>

                        <!-- Body: attributes + status -->
                        <div class="variant-card-body">
                            <div class="tags" th:if="${!variant.attributes.isEmpty()}">
                                <span th:each="entry : ${variant.attributes}"
                                      class="badge badge-outline"
                                      th:data-attr-key="${entry.key}"
                                      th:data-attr-value="${entry.value}"
                                      th:text="${entry.key + '=' + entry.value}"></span>
                            </div>
                            <div class="variant-card-status">
                                <span th:if="${variant.hasDraft}" class="badge badge-draft">Draft</span>
                                <span th:if="${!variant.publishedVersions.isEmpty()}"
                                      class="badge badge-published"
                                      th:text="${#lists.size(variant.publishedVersions) + ' published'}"></span>
                                <span th:if="${!variant.hasDraft and variant.publishedVersions.isEmpty()}"
                                      class="text-muted" style="font-size: var(--ep-text-xs);">No versions</span>
                            </div>
                        </div>

                        <!-- Footer: actions -->
                        <div class="variant-card-footer">
                            <a th:href="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/editor(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                               class="btn btn-sm btn-icon btn-ghost" hx-boost="false" title="Open editor">
                                <th:block th:replace="~{fragments/icon :: icon(name='pencil', class='ep-icon ep-icon-sm')}" />
                            </a>
                            <button type="button" class="btn btn-sm btn-icon btn-ghost"
                                    th:data-variant-id="${variant.id}"
                                    th:data-versions-url="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/versions(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                    onclick="openVersionHistory(this)"
                                    title="Version history">
                                <th:block th:replace="~{fragments/icon :: icon(name='clock', class='ep-icon ep-icon-sm')}" />
                            </button>
                            <button type="button" class="btn btn-sm btn-icon btn-ghost"
                                    th:hx-get="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/edit(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                    hx-target="#edit-variant-dialog-body"
                                    hx-swap="innerHTML"
                                    onclick="document.getElementById('edit-variant-dialog').showModal()"
                                    title="Edit variant">
                                <th:block th:replace="~{fragments/icon :: icon(name='settings', class='ep-icon ep-icon-sm')}" />
                            </button>
                            <form th:unless="${variant.isDefault}"
                                  th:hx-post="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/set-default(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                  hx-target="#variants-section" hx-swap="outerHTML"
                                  hx-confirm="Make this the default variant?">
                                <button type="submit" class="btn btn-sm btn-icon btn-ghost" title="Set as default">
                                    <th:block th:replace="~{fragments/icon :: icon(name='star', class='ep-icon ep-icon-sm')}" />
                                </button>
                            </form>
                            <form th:unless="${variant.isDefault}"
                                  th:action="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}/delete(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                  method="post"
                                  th:hx-delete="@{/tenants/{tenantId}/templates/{id}/variants/{variantId}(tenantId=${tenantId},id=${template.id},variantId=${variant.id})}"
                                  hx-confirm="Are you sure you want to delete this variant?"
                                  hx-target="#variants-section"
                                  hx-swap="outerHTML">
                                <button type="submit" class="btn btn-sm btn-icon btn-ghost btn-ghost-destructive" title="Delete variant">
                                    <th:block th:replace="~{fragments/icon :: icon(name='trash-2', class='ep-icon ep-icon-sm')}" />
                                </button>
                            </form>
                            <button th:if="${variant.isDefault}" type="button"
                                    class="btn btn-sm btn-icon btn-ghost" disabled
                                    title="Cannot delete the default variant">
                                <th:block th:replace="~{fragments/icon :: icon(name='trash-2', class='ep-icon ep-icon-sm')}" />
                            </button>
                        </div>
                    </div>

                    <div class="variant-no-matches" id="variant-no-matches">
                        No variants match the selected filters.
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(variants)}" class="detail-section">
                    <div class="detail-section-body">
                        <div class="empty-state" style="padding: var(--ep-space-8);">
                            <div class="empty-state-title">No variants yet</div>
                            <div class="empty-state-description">Create a variant to start designing your template.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit variant dialog -->
            <dialog id="edit-variant-dialog" class="ep-dialog">
                <div id="edit-variant-dialog-body">
                    <!-- Content loaded via HTMX -->
                </div>
            </dialog>

            <!-- Version history dialog -->
            <dialog id="version-history-dialog" class="ep-dialog ep-dialog-wide">
                <div id="version-history-dialog-body">
                    <!-- Content loaded via HTMX -->
                </div>
            </dialog>
        </div>

        <!-- Tab Panel: Deployments -->
        <div id="tab-deployments" class="tab-panel">
            <div id="deployments-content">
                <!-- Lazy-loaded via HTMX on first tab switch -->
            </div>
        </div>

        <!-- Tab Panel: Data Contract -->
        <div id="tab-data-contract" class="tab-panel">
            <div class="detail-section">
                <div class="detail-section-header">
                    <h3>Data Contract</h3>
                </div>
                <div class="detail-section-body">
                    <p class="text-muted" style="margin-bottom: var(--ep-space-4); font-size: var(--ep-text-sm);">
                        Define the JSON schema and test data examples for this template.
                    </p>
                    <div id="schema-manager-container"></div>
                </div>
            </div>
        </div>

        <!-- Tab Panel: Settings -->
        <div id="tab-settings" class="tab-panel">
            <!-- Details -->
            <div class="detail-section">
                <div class="detail-section-header">
                    <h3>Details</h3>
                </div>
                <div class="detail-section-body">
                    <dl class="description-list">
                        <dt>ID</dt>
                        <dd><code th:text="${template.id}"></code></dd>
                        <dt>Created</dt>
                        <dd th:text="${#temporals.format(template.createdAt, 'yyyy-MM-dd HH:mm')}"></dd>
                        <dt>Modified</dt>
                        <dd th:text="${#temporals.format(template.lastModified, 'yyyy-MM-dd HH:mm')}"></dd>
                    </dl>
                </div>
            </div>

            <!-- Default Theme -->
            <div class="detail-section" id="theme-section" th:fragment="theme-section">
                <div class="detail-section-header">
                    <h3>Default Theme</h3>
                </div>
                <div class="detail-section-body">
                    <p class="text-muted" style="margin-bottom: var(--ep-space-4); font-size: var(--ep-text-sm);">
                        Set the default theme for all variants. Individual variants can override this in the editor.
                    </p>
                    <div class="form-row">
                        <div class="form-group" style="margin-bottom: 0;">
                            <select id="theme-select"
                                    name="themeId"
                                    class="ep-select"
                                    onchange="updateTheme(this)">
                                <option value="">No theme (use variant defaults)</option>
                                <option th:each="theme : ${themes}"
                                        th:value="${theme.id}"
                                        th:text="${theme.name}"
                                        th:selected="${template.themeId != null and template.themeId.equals(theme.id)}"></option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="detail-section danger-zone">
                <div class="detail-section-header">
                    <h3>Danger Zone</h3>
                </div>
                <div class="detail-section-body">
                    <p class="text-muted" style="margin-bottom: var(--ep-space-4); font-size: var(--ep-text-sm);">
                        Permanently delete this template and all its variants, versions, and data.
                    </p>
                    <form th:action="@{/tenants/{tenantId}/templates/{id}/delete(tenantId=${tenantId},id=${template.id})}"
                          method="post"
                          hx-boost="false"
                          onsubmit="return confirm('Are you sure you want to delete this template? This action cannot be undone.')">
                        <button type="submit" class="btn btn-sm btn-destructive">Delete Template</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Scripts -->
        <script th:inline="javascript">
            const TENANT_ID = [[${tenantId}]];
            const TEMPLATE_ID = [[${template.id}]];
            const INITIAL_SCHEMA = [[${template.dataModel}]];
            const INITIAL_EXAMPLES = [[${template.dataExamples}]];

            const deploymentsUrl = [[${'/tenants/' + tenantId + '/templates/' + template.id + '/deployments'}]];
            let deploymentsLoaded = false;

            function updateTheme(select) {
                const themeId = select.value || null;
                const clearThemeId = !select.value;
                const url = [[${'/tenants/' + tenantId + '/templates/' + template.id + '/theme'}]];
                const csrfToken = typeof window.getCsrfToken === 'function' ? window.getCsrfToken() : '';

                fetch(url, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-XSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify({ themeId: themeId, clearThemeId: clearThemeId })
                })
                .then(response => response.text())
                .then(html => {
                    const section = document.getElementById('theme-section');
                    section.outerHTML = html;
                });
            }

            function switchTab(tabId) {
                document.querySelectorAll('.tab-nav-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
                document.getElementById('tab-' + tabId).classList.add('active');

                // Lazy-load deployments on first switch
                if (tabId === 'deployments' && !deploymentsLoaded) {
                    htmx.ajax('GET', deploymentsUrl, { target: '#deployments-content', swap: 'innerHTML' });
                    deploymentsLoaded = true;
                }
            }

            function toggleCreateVariantForm() {
                const form = document.getElementById('create-variant-form');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            }

            function openVersionHistory(button) {
                const variantId = button.dataset.variantId;
                const versionsUrl = button.dataset.versionsUrl;
                const container = document.getElementById('version-history-dialog-body');
                htmx.ajax('GET', versionsUrl, { target: container, swap: 'innerHTML' });
                document.getElementById('version-history-dialog').showModal();
            }

            function filterVariants() {
                const filterBar = document.getElementById('variant-filter-bar');
                if (!filterBar) return;

                const filters = {};
                filterBar.querySelectorAll('select[data-filter-key]').forEach(function(select) {
                    const key = select.dataset.filterKey;
                    const value = select.value;
                    if (value) filters[key] = value;
                });

                const cards = document.querySelectorAll('.variant-card');
                let visibleCount = 0;

                cards.forEach(function(card) {
                    const attrs = {};
                    card.querySelectorAll('[data-attr-key]').forEach(function(badge) {
                        attrs[badge.dataset.attrKey] = badge.dataset.attrValue;
                    });

                    let matches = true;
                    for (const key in filters) {
                        if (attrs[key] !== filters[key]) {
                            matches = false;
                            break;
                        }
                    }

                    card.style.display = matches ? '' : 'none';
                    if (matches) visibleCount++;
                });

                const noMatches = document.getElementById('variant-no-matches');
                if (noMatches) {
                    noMatches.style.display = (visibleCount === 0 && cards.length > 0) ? 'block' : 'none';
                }
            }

            // Re-apply filters after HTMX swaps the variants section
            document.addEventListener('htmx:afterSwap', function(event) {
                if (event.detail.target && event.detail.target.id === 'variants-section') {
                    filterVariants();
                }
            });
        </script>
        <script type="module">
            import { mountDataContractEditor } from '/editor/data-contract-editor.js';

            const tenantId = TENANT_ID;
            const templateId = TEMPLATE_ID;
            const initialSchema = INITIAL_SCHEMA;
            const initialExamples = INITIAL_EXAMPLES;

            const editor = mountDataContractEditor({
                container: document.getElementById('schema-manager-container'),
                templateId: templateId,
                initialSchema: initialSchema,
                initialExamples: initialExamples,
                callbacks: {
                    onSaveSchema: async (schema, forceUpdate) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-XSRF-TOKEN': typeof window.getCsrfToken === 'function' ? window.getCsrfToken() : ''
                                },
                                body: JSON.stringify({ dataModel: schema, forceUpdate })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                return { success: false, error: error.message, warnings: error.warnings };
                            }

                            const result = await response.json();
                            return { success: true, warnings: result.warnings };
                        } catch (error) {
                            console.error('Failed to save schema:', error);
                            return { success: false, error: error.message };
                        }
                    },

                    onSaveDataExamples: async (examples) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-XSRF-TOKEN': typeof window.getCsrfToken === 'function' ? window.getCsrfToken() : ''
                                },
                                body: JSON.stringify({ dataExamples: examples })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                return { success: false, warnings: error.warnings };
                            }

                            const result = await response.json();
                            return { success: true, warnings: result.warnings };
                        } catch (error) {
                            console.error('Failed to save examples:', error);
                            return { success: false };
                        }
                    },

                    onUpdateDataExample: async (exampleId, updates, forceUpdate) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}/data-examples/${exampleId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-XSRF-TOKEN': typeof window.getCsrfToken === 'function' ? window.getCsrfToken() : ''
                                },
                                body: JSON.stringify({ ...updates, forceUpdate })
                            });

                            if (!response.ok) {
                                const error = await response.json();
                                return { success: false, errors: error.errors, warnings: error.warnings };
                            }

                            const result = await response.json();
                            return { success: true, example: result, warnings: result.warnings };
                        } catch (error) {
                            console.error('Failed to update example:', error);
                            return { success: false };
                        }
                    },

                    onDeleteDataExample: async (exampleId) => {
                        try {
                            const response = await fetch(`/tenants/${tenantId}/templates/${templateId}/data-examples/${exampleId}`, {
                                method: 'DELETE',
                                headers: {
                                    'X-XSRF-TOKEN': typeof window.getCsrfToken === 'function' ? window.getCsrfToken() : ''
                                }
                            });

                            return { success: response.ok };
                        } catch (error) {
                            console.error('Failed to delete example:', error);
                            return { success: false };
                        }
                    }
                }
            });
        </script>
    </th:block>

    <!-- Fragment: edit variant form (loaded into dialog via HTMX) -->
    <th:block th:fragment="edit-variant-form">
        <div class="ep-dialog-header">
            <h3>Edit Variant: <code th:text="${variant.id}"></code></h3>
        </div>
        <form th:hx-patch="@{/tenants/{tenantId}/templates/{templateId}/variants/{variantId}(tenantId=${tenantId},templateId=${templateId ?: template.id},variantId=${variant.id})}"
              hx-target="#variants-section"
              hx-swap="outerHTML"
              hx-on::after-request="if(event.detail.successful) document.getElementById('edit-variant-dialog').close()">
            <div class="ep-dialog-body">
                <div class="form-group">
                    <label class="ep-label" for="edit-variant-title">Title</label>
                    <input type="text" id="edit-variant-title" name="title" class="ep-input"
                           th:value="${variant.title}" placeholder="e.g. English Newsletter">
                </div>
                <div th:if="${attributeDefinitions != null and !#lists.isEmpty(attributeDefinitions)}">
                    <div class="form-group" th:each="attrDef : ${attributeDefinitions}">
                        <label class="ep-label" th:for="'edit-attr_' + ${attrDef.id}" th:text="${attrDef.displayName}"></label>
                        <select th:id="'edit-attr_' + ${attrDef.id}" th:name="'attr_' + ${attrDef.id}" class="ep-select">
                            <option value="">- Not set -</option>
                            <option th:if="${!attrDef.allowedValues.isEmpty()}"
                                    th:each="val : ${attrDef.allowedValues}"
                                    th:value="${val}"
                                    th:text="${val}"
                                    th:selected="${variant.attributes != null and variant.attributes.containsKey(attrDef.id.toString()) and variant.attributes.get(attrDef.id.toString()) == val}"></option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="ep-dialog-footer">
                <button type="button" class="btn btn-ghost"
                        onclick="document.getElementById('edit-variant-dialog').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </th:block>
</body>
</html>
