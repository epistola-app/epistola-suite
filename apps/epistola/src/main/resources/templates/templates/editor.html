<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="${templateName + ' - Edit - Epistola'}">
      Edit Template - Epistola
    </title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/vanilla-editor/vanilla-editor.css}" />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        overflow: hidden;
      }

      :root {
        --editor-header-height: 3.5rem;
        --editor-main-padding: 1rem;
      }

      .editor-page {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .editor-header {
        padding: 0.625rem 1.5rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
        height: var(--editor-header-height);
      }

      .editor-header h1 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
      }

      .editor-header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .editor-main {
        flex: 1;
        overflow: hidden;
        padding: var(--editor-main-padding);
        background: #f1f5f9;
        height: calc(100vh - var(--editor-header-height));
      }

      #editor-root {
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="editor-page">
      <header class="editor-header">
        <div class="editor-header-left">
          <a
            th:href="@{/tenants/{tenantId}/templates/{id}(tenantId=${tenantId},id=${templateId})}"
            class="btn btn-sm btn-outline-secondary"
          >
            <i class="bi bi-arrow-left"></i> Back
          </a>
          <h1 th:text="${templateName}">Template Name</h1>
          <span
            th:if="${variantTags != null and !variantTags.isEmpty()}"
            class="d-flex gap-1"
          >
            <span
              th:each="entry : ${variantTags}"
              class="badge bg-light text-dark border"
              th:text="${entry.key + '=' + entry.value}"
            ></span>
          </span>
        </div>
      </header>

      <main class="editor-main">
        <div id="editor-root"></div>
      </main>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      window.TEMPLATE_MODEL = /*[[${templateModel}]]*/ {};
      window.TEMPLATE_ID = /*[[${templateId}]]*/ "";
      window.TENANT_ID = /*[[${tenantId}]]*/ "";
      window.VARIANT_ID = /*[[${variantId}]]*/ "";
      window.DATA_EXAMPLES = /*[[${dataExamples}]]*/ [];
      window.DATA_MODEL = /*[[${dataModel}]]*/ null;
      window.THEMES = /*[[${themes}]]*/ [];
      window.DEFAULT_THEME = /*[[${defaultTheme}]]*/ null;
      window.getCsrfToken = function () {
        const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
      };
      /*]]>*/
    </script>

    <script type="module">
      import { mountEditorApp } from "/vanilla-editor/vanilla-editor.js";

      const mounted = mountEditorApp({
        container: "#editor-root",
        template: window.TEMPLATE_MODEL,
        themes: window.THEMES || [],
        defaultTheme: window.DEFAULT_THEME || null,
        dataExamples: window.DATA_EXAMPLES || [],
        schema: window.DATA_MODEL || null,
        onSave: async (template) => {
          const response = await fetch(
            `/tenants/${window.TENANT_ID}/templates/${window.TEMPLATE_ID}/variants/${window.VARIANT_ID}/draft`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "X-XSRF-TOKEN": window.getCsrfToken(),
              },
              body: JSON.stringify({ templateModel: template }),
            },
          );

          if (!response.ok) {
            throw new Error("Save failed");
          }
        },
        onPreview: async (template, data) => {
          const response = await fetch(
            `/tenants/${window.TENANT_ID}/templates/${window.TEMPLATE_ID}/variants/${window.VARIANT_ID}/preview`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-XSRF-TOKEN": window.getCsrfToken(),
              },
              body: JSON.stringify({
                data,
                templateModel: template,
              }),
            },
          );

          if (!response.ok) {
            throw new Error("Preview failed");
          }

          return await response.blob();
        },
      });
    </script>
  </body>
</html>
