<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Load Test Details - Epistola</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
</head>
<body>
    <main class="regular">
        <h1>Load Test Details</h1>
        <p class="subtitle">
            Test <strong th:text="${run.id}"></strong> for tenant <strong th:text="${tenantId}"></strong>
        </p>

        <section>
            <h2>Configuration</h2>
            <table class="key-value-table">
                <tr>
                    <th>Template:</th>
                    <td>
                        <span th:if="${template != null}" th:text="${template.name}"></span>
                        <span class="text-muted" th:text="'(' + ${run.templateId} + ')'"></span>
                    </td>
                </tr>
                <tr>
                    <th>Variant:</th>
                    <td th:text="${run.variantId}"></td>
                </tr>
                <tr>
                    <th>Version:</th>
                    <td>
                        <span th:if="${run.versionId != null}" th:text="${run.versionId}"></span>
                        <span th:if="${run.environmentId != null}" th:text="'Environment: ' + ${run.environmentId}"></span>
                    </td>
                </tr>
                <tr>
                    <th>Target Count:</th>
                    <td th:text="${run.targetCount}"></td>
                </tr>
                <tr>
                    <th>Concurrency Level:</th>
                    <td th:text="${run.concurrencyLevel}"></td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td>
                        <span class="badge"
                              th:classappend="${run.status.name() == 'COMPLETED'} ? 'badge-success' :
                                              ${run.status.name() == 'RUNNING'} ? 'badge-info' :
                                              ${run.status.name() == 'FAILED'} ? 'badge-error' :
                                              ${run.status.name() == 'CANCELLED'} ? 'badge-warning' : 'badge-default'"
                              th:text="${run.status}">
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>Created:</th>
                    <td th:text="${#temporals.format(run.createdAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                <tr th:if="${run.startedAt != null}">
                    <th>Started:</th>
                    <td th:text="${#temporals.format(run.startedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
                <tr th:if="${run.completedAt != null}">
                    <th>Completed:</th>
                    <td th:text="${#temporals.format(run.completedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
                </tr>
            </table>
        </section>

        <!-- Metrics section (polled for updates when RUNNING) -->
        <div id="metrics-section"
             th:fragment="metrics-section"
             th:hx-get="${run.status.name() == 'RUNNING'} ? @{/tenants/{tenantId}/load-tests/{runId}/metrics(tenantId=${tenantId},runId=${run.id})} : ''"
             th:hx-trigger="${run.status.name() == 'RUNNING'} ? 'every 2s' : ''"
             hx-swap="outerHTML">

            <!-- Progress (shown when RUNNING) -->
            <section th:if="${run.status.name() == 'RUNNING'}">
                <h2>Progress</h2>
                <div class="progress-container">
                    <div class="progress-bar"
                         th:style="'width: ' + ${(run.completedCount + run.failedCount) * 100.0 / run.targetCount} + '%'">
                    </div>
                </div>
                <p class="text-center">
                    <strong th:text="${run.completedCount + run.failedCount}"></strong> /
                    <strong th:text="${run.targetCount}"></strong> completed
                    (<span th:text="${#numbers.formatDecimal((run.completedCount + run.failedCount) * 100.0 / run.targetCount, 1, 1)}"></span>%)
                </p>
            </section>

            <!-- Metrics (shown when COMPLETED or FAILED) -->
            <section th:if="${run.status.name() == 'COMPLETED' or run.status.name() == 'FAILED'}">
                <h2>Results</h2>

                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">Requests</div>
                        <div class="metric-value" th:text="${run.completedCount + run.failedCount} + ' / ' + ${run.targetCount}"></div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Success Rate</div>
                        <div class="metric-value">
                            <span th:if="${run.successRatePercent != null}"
                                  th:text="${#numbers.formatDecimal(run.successRatePercent, 1, 1)} + '%'"></span>
                            <span th:unless="${run.successRatePercent != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Avg Response Time</div>
                        <div class="metric-value">
                            <span th:if="${run.avgResponseTimeMs != null}"
                                  th:text="${#numbers.formatDecimal(run.avgResponseTimeMs, 1, 0)} + ' ms'"></span>
                            <span th:unless="${run.avgResponseTimeMs != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Requests/sec</div>
                        <div class="metric-value">
                            <span th:if="${run.requestsPerSecond != null}"
                                  th:text="${#numbers.formatDecimal(run.requestsPerSecond, 1, 2)}"></span>
                            <span th:unless="${run.requestsPerSecond != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">p50 (Median)</div>
                        <div class="metric-value">
                            <span th:if="${run.p50ResponseTimeMs != null}"
                                  th:text="${run.p50ResponseTimeMs} + ' ms'"></span>
                            <span th:unless="${run.p50ResponseTimeMs != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">p95</div>
                        <div class="metric-value">
                            <span th:if="${run.p95ResponseTimeMs != null}"
                                  th:text="${run.p95ResponseTimeMs} + ' ms'"></span>
                            <span th:unless="${run.p95ResponseTimeMs != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">p99</div>
                        <div class="metric-value">
                            <span th:if="${run.p99ResponseTimeMs != null}"
                                  th:text="${run.p99ResponseTimeMs} + ' ms'"></span>
                            <span th:unless="${run.p99ResponseTimeMs != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Min / Max</div>
                        <div class="metric-value">
                            <span th:if="${run.minResponseTimeMs != null and run.maxResponseTimeMs != null}"
                                  th:text="${run.minResponseTimeMs} + ' / ' + ${run.maxResponseTimeMs} + ' ms'"></span>
                            <span th:unless="${run.minResponseTimeMs != null and run.maxResponseTimeMs != null}">-</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-label">Total Duration</div>
                        <div class="metric-value">
                            <span th:if="${run.totalDurationMs != null}"
                                  th:text="${#numbers.formatDecimal(run.totalDurationMs / 1000.0, 1, 2)} + ' sec'"></span>
                            <span th:unless="${run.totalDurationMs != null}">-</span>
                        </div>
                    </div>
                </div>

                <!-- Error Summary (if any failures) -->
                <div th:if="${run.failedCount > 0 and run.errorSummary != null}" class="error-summary">
                    <h3>Error Summary</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Error Type</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="entry : ${run.errorSummary}">
                                <td th:text="${entry.key}"></td>
                                <td th:text="${entry.value}"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="actions-bar">
            <a th:href="@{/tenants/{tenantId}/load-tests/{runId}/requests(tenantId=${tenantId},runId=${run.id})}"
               class="btn btn-primary"
               th:if="${run.status.name() == 'COMPLETED' or run.status.name() == 'FAILED'}">
                View Detailed Request Log
            </a>
            <form th:if="${run.status.name() == 'RUNNING'}"
                  th:action="@{/tenants/{tenantId}/load-tests/{runId}/cancel(tenantId=${tenantId},runId=${run.id})}"
                  method="post"
                  style="display: inline;">
                <button type="submit" class="btn btn-warning">Cancel Test</button>
            </form>
            <a th:href="@{/tenants/{id}/load-tests(id=${tenantId})}" class="btn btn-secondary">Back to List</a>
        </div>
    </main>

    <th:block th:replace="~{fragments/footer :: footer}" />
</body>
</html>
